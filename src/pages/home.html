<!DOCTYPE html>
<html manifest="/manifest.appcache">
  <head>
    <title>Converso Chat</title>
    <link rel="stylesheet" href="/style.css" type="text/css" />
  </head>
  <body>
    <!-- Page structure -->
    <h1 id="pageTitle">Chat</h1>
    <div id="contacts-title">Your contacts:</div>
    <div id="contacts-container"></div>
    <div id="userList-title">Find user:</div>
    <select id="userList" onchange="openDialog(this.value)">
      <option value="" selected disabled>Select a user</option>
    </select>
    <input type="text" id="userSearch" oninput="searchUsers()" placeholder="Search by name">
    <h2 id="dialogTitle">Dialog with:</h2>
    <div id="chat"></div>
    
    <!-- Input field and button for sending messages -->
    <input type="text" id="msg" />
    <button type="submit" onclick="sendMessage()">Send</button>
    
    <!-- Container for displaying messages -->
    <ul id="messageList"></ul>

    <a href="/logout">Logout</a>
    <script>
      // Retrieve URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      // Get the 'sender' from URL parameters
      const sender = urlParams.get('user');
      // WebSocket URL
      const wsUrl = 'ws://localhost:3000';

      // Variables for managing the current dialog
      let receiver;
      let currentDialog = null;

      // Update the page title with the sender's name
      const h1Element = document.getElementById('pageTitle');
      h1Element.innerText = `${sender}'s Homepage`;

      // Function to create a chat div for a other div
      const createDivInOtherDiv = (parentDiv, childDivId, childDivName) => {
        const childDiv = document.createElement('div');
        childDiv.id = `chat_${childDivId}`;
        if (childDivName) {
          childDiv.innerHTML = `<h2>${childDivName}</h2>`;
          return childDiv;
        }
        // If there is no div name, use id instead
        childDiv.innerHTML = `<h2>${childDivId}</h2>`;
        return childDiv;
      };

      const ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('WebSocket connection established');
        ws.send(JSON.stringify(sender));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.hasOwnProperty('contacts')) {
          populateContactsList(data.contacts);
          populateUsersList(data.users);
        }

        // Check if the received data is empty
        if (data.length === 0) {
          return;
        }

        const firstItem = data[0];

        if (typeof firstItem === 'object') {
          // Handle history items
          if (firstItem.hasOwnProperty('history')) {
            data.forEach((item) => {
              const listItem = document.createElement('li');
              listItem.innerText = `${item.sender}: ${item.history}`;
              messageList.appendChild(listItem);
            });
          }
          // Handle messages from WebSocket session
          if (firstItem.hasOwnProperty('message')) {
            // Check if the message belongs to the current dialog
            if (firstItem.sender !== currentDialog) {
              return;
            }
            data.forEach((item) => {
              const listItem = document.createElement('li');
              listItem.innerText = `${item.sender}: ${item.message}`;
              messageList.appendChild(listItem);
            });
          }
        }
      };

      // Function to open a dialog with a selected contact
      const openDialog = (selectedContact) => {
        const parentChatDiv = document.getElementById('chat');
        // Clear the message list
        messageList.innerHTML = '';

        // Update the current dialog and chat section
        currentDialog = selectedContact;
        document.getElementById('chat').innerHTML = '';

        const chatDiv = createDivInOtherDiv(parentChatDiv, selectedContact);
        document.getElementById('chat').appendChild(chatDiv);

        receiver = selectedContact;

        // Send a request to the WebSocket server to open the dialog
        const data = { sender: sender, receiver: selectedContact };
        ws.send(JSON.stringify(data));
        console.log(`Dialog between ${data.sender} and ${data.receiver} opened!`);
      };

      // Function to send a message
      const sendMessage = () => {
        const message = document.getElementById('msg').value;

        // Check if there is a message and receiver specified
        if (message && receiver) {
          const listItem = document.createElement('li');
          listItem.innerText = `${sender}: ${message}`;
          messageList.appendChild(listItem);

          // Send the message to the WebSocket server
          const data = { sender, message, receiver };
          ws.send(JSON.stringify(data));
          console.log(`message: ${message}, receiver: ${receiver}, sender: ${sender}`);
        } else {
          const error = 'Error: There is no message or receiver';
          alert(message);
          console.log(message);
        }
      };

      // Function to search users by name
      const searchUsers = () => {
        const input = document.getElementById('userSearch');
        const filter = input.value.toLowerCase();
        const userList = document.getElementById('userList');
        const options = userList.getElementsByTagName('option');

        const optionsArray = Array.from(options);
        optionsArray.forEach((option) => {
          const username = option.text.toLowerCase();
          if (username.includes(filter)) {
            option.style.display = '';
          } else {
            option.style.display = 'none';
          }
        });
      };

      // Function to populate the user list in the dropdown
      const populateUsersList = (data) => {
        const userList = document.getElementById('userList');
        userList.innerHTML = '<option value="" selected disabled>Select a user</option>';

        data.forEach((item) => {
          const option = document.createElement('option');
          option.value = item;
          option.text = item;
          userList.appendChild(option);
        });
      };

      // Function to populate the contacts list with buttons
      const populateContactsList = (data) => {
        const contactsContainer = document.getElementById('contacts-container');
        contactsContainer.innerHTML = ''; // Clear the container

        data.forEach((item) => {
          const button = document.createElement('button');
          button.innerText = item;
          button.onclick = () => openDialog(item); // On click, open dialog with contact
          contactsContainer.appendChild(button);
        });
      };
    </script>
  </body>
</html>
